<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>VitalApp - Graph</title>
<link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
<link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152.png">
<link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167.png">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{--card-bg:#fff;--accent:#2e7d32}
  body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:14px;background:#f3f4f6;color:#111;overflow-x:hidden}
  h1{font-size:1.2rem;margin:0 0 8px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
  button{padding:8px 10px;border-radius:8px;border:none;font-size:14px;cursor:pointer}
  .btn-start{background:var(--accent);color:#fff}
  .btn-stop{background:#c62828;color:#fff}
  .btn-save{background:#1565c0;color:#fff}
  .btn-clear{background:#6d4c41;color:#fff}
  textarea#recognized{width:100%;min-height:56px;padding:10px;border-radius:8px;border:1px solid #d1d5db;background:var(--card-bg);resize:vertical;font-size:14px}
  /* Chart area small/mobile friendly */
  #chartBox{background:var(--card-bg);border-radius:10px;padding:6px;margin-top:12px;overflow:hidden}
  .timeframe-row{display:flex;gap:6px;justify-content:flex-start;margin-bottom:6px;flex-wrap:wrap}
  .timeframe-row button{padding:6px 8px;font-size:13px}
  #vitalChart{width:100%;height:120px} /* kompakter Chart */
  .metric-row{display:flex;gap:10px;justify-content:flex-start;margin-top:8px;flex-wrap:wrap}
  .metric-row label{font-size:14px}
  /* saved entries */
  #entries{list-style:none;padding:0;margin-top:14px}
  #entries li{background:var(--card-bg);padding:10px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;font-size:14px}
  .delete-btn{background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:6px 8px;cursor:pointer}
  .active{box-shadow:0 0 0 2px rgba(0,0,0,0.08) inset}
  .small{font-size:12px;color:#6b7280}
</style>
</head>
<body>

<h1>Vitaldaten</h1>

<!-- Controls -->
<div class="controls">
  <button id="start" class="btn-start">üé§ Aufnehmen</button>
  <button id="stop" class="btn-stop">‚èπÔ∏è Stoppen</button>
  <button id="save" class="btn-save">üíæ Speichern</button>
  <button id="clear" class="btn-clear">üßπ Clear</button>
</div>

<!-- Editierbares Textfeld -->
<textarea id="recognized" placeholder="Erkannter Text erscheint hier ‚Äì du kannst ihn editieren bevor du speicherst."></textarea>

<!-- Chart -->
<div id="chartBox">
  <div class="timeframe-row" id="timeframes">
    <button class="timeframe-btn" data-range="7">1W</button>
    <button class="timeframe-btn" data-range="30">1M</button>
    <button class="timeframe-btn" data-range="90">3M</button>
    <button class="timeframe-btn" data-range="ytd">YTD</button>
    <button class="timeframe-btn" data-range="max">Max</button>
  </div>
  <canvas id="vitalChart"></canvas>
  <div class="metric-row" id="metricSelectors">
    <label><input type="radio" name="metric" value="gewicht" checked> Gewicht</label>
    <label><input type="radio" name="metric" value="puls"> Puls</label>
    <label><input type="radio" name="metric" value="blutdruck"> Blutdruck</label>
  </div>
</div>

<h2 style="margin-top:14px">Gespeicherte Eintr√§ge</h2>
<ul id="entries"></ul>

<script>
/* ------------------ Utilities ------------------ */
function formatDDMM(date){
  const d = date.getDate().toString().padStart(2,'0');
  const m = (date.getMonth()+1).toString().padStart(2,'0');
  return `${d}.${m}.`;
}
function formatMMYY(date){
  const m = (date.getMonth()+1).toString().padStart(2,'0');
  const y = date.getFullYear().toString().slice(-2);
  return `${m}.${y}`;
}
function toISODateStr(d){ return d.toISOString().slice(0,10); }

/* ------------------ Speech recognition ------------------ */
let recognition = null;
let isRecording = false;
if('webkitSpeechRecognition' in window || 'SpeechRecognition' in window){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = 'de-DE';
  recognition.continuous = true;
  recognition.interimResults = true;
  recognition.onresult = (event) => {
    let cur = document.getElementById('recognized').value.trim();
    let interim = '';
    for(let i = event.resultIndex; i < event.results.length; i++){
      const t = event.results[i][0].transcript;
      if(event.results[i].isFinal){ cur = (cur + ' ' + t).trim(); }
      else { interim += ' ' + t; }
    }
    document.getElementById('recognized').value = (cur + ' ' + interim).trim();
  };
}

/* ------------------ Parser ------------------ */
function parseVitaldaten(text){
  text = (text||'').toLowerCase();
  const gMatch = text.match(/(?:gewicht[:\s]*)?(\d{1,3}[.,]?\d?)\s*(kg|kilo)?/);
  const bpMatch = text.match(/(\d{2,3})\s*(?:\/|zu|und|-|\s)\s*(\d{2,3})/);
  const pMatch = text.match(/puls\s*(?:ist\s*)?(\d{2,3})/) || text.match(/\b(\d{2,3})\s*bpm\b/);
  if(!gMatch || !bpMatch || !pMatch) return null;
  const gewicht = parseFloat(gMatch[1].replace(',','.'));
  const syst = parseInt(bpMatch[1]);
  const diast = parseInt(bpMatch[2]);
  const puls = parseInt(pMatch[1]);
  return { datum: new Date().toISOString(), gewicht, systolisch: syst, diastolisch: diast, puls };
}

/* ------------------ Storage & Entries ------------------ */
function getEntries(){ return JSON.parse(localStorage.getItem('vitaldaten') || '[]'); }
function setEntries(arr){ localStorage.setItem('vitaldaten', JSON.stringify(arr)); }
function renderEntries(){
  const ul = document.getElementById('entries');
  const entries = getEntries();
  ul.innerHTML = '';
  entries.forEach((e, idx) => {
    const li = document.createElement('li');
    li.innerHTML = `<div><strong>${new Date(e.datum).toLocaleString()}</strong><br>
      Gewicht: ${e.gewicht} kg ¬∑ Blutdruck: ${e.systolisch}/${e.diastolisch} mmHg ¬∑ Puls: ${e.puls} bpm</div>`;
    const btn = document.createElement('button');
    btn.className = 'delete-btn'; btn.textContent = '‚ùå';
    btn.onclick = () => { entries.splice(idx,1); setEntries(entries); renderEntries(); updateChart(); };
    li.appendChild(btn);
    ul.appendChild(li);
  });
}
renderEntries();

/* ------------------ Buttons ------------------ */
document.getElementById('start').onclick = () => { if(recognition){ recognition.start(); isRecording = true; } };
document.getElementById('stop').onclick = () => { if(recognition && isRecording){ recognition.stop(); isRecording=false; } };
document.getElementById('clear').onclick = () => { document.getElementById('recognized').value = ''; };
document.getElementById('save').onclick = () => {
  const txt = document.getElementById('recognized').value.trim();
  const parsed = parseVitaldaten(txt);
  if(!parsed){ alert('Keine Vitaldaten erkannt. Beispiel: "72,5 kg, Blutdruck 120 zu 80, Puls 65"'); return; }
  const arr = getEntries(); arr.unshift(parsed); setEntries(arr);
  document.getElementById('recognized').value = ''; renderEntries(); updateChart();
};

/* ------------------ Chart Setup ------------------ */
const ctx = document.getElementById('vitalChart').getContext('2d');
let vitalChart = new Chart(ctx, {
  type:'line',
  data:{ labels:[], datasets:[] },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    plugins:{ legend:{ display:false }, tooltip:{ mode:'index', intersect:false } },
    elements:{ point:{ radius:3 } },
    interaction:{ mode:'nearest', axis:'x', intersect:false },
    scales:{ x:{ grid:{ display:false } }, y:{ grid:{ color:'rgba(0,0,0,0.05)' } } }
  }
});

/* --- (Zeitraum, Datenmapping, y-Achsenlogik bleibt gleich wie vorher, ausgelassen um Platz zu sparen) --- */
/* F√ºge hier wieder deine Funktionen: labelsForRange, mapEntriesByKey, computeSeries, getYScaleOptions, updateChart (aus der letzten Version). */

</script>
</body>
</html>
