<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VitalApp</title>
  <link rel="apple-touch-icon" sizes="120x120" href="apple-touch-icon.png" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f9f9f9;
    }
    h1 { font-size: 20px; margin-bottom: 10px; }
    button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 5px 0;
    }
    #record { background: #4caf50; color: white; }
    #stop { background: #f44336; color: white; }
    #save { background: #1565c0; color: white; }
    #recognized {
      width: 100%;
      height: 80px;
      margin: 10px 0;
      padding: 8px;
      font-size: 16px;
    }
    #chartBox {
      background: #fff;
      border-radius: 10px;
      padding: 4px;
      margin: 15px 0;
      height: 200px;
    }
    #vitalChart { width: 100%; height: 100%; }
    #timeFilters, #metricFilters { margin: 8px 0; }
    #timeFilters button, #metricFilters button {
      background: #eee;
      margin-right: 5px;
      font-size: 14px;
    }
    ul { list-style: none; padding: 0; }
    li { background: #fff; margin: 5px 0; padding: 8px; border-radius: 6px; }
    .delete-btn {
      float: right;
      background: #f44336;
      color: white;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Vitaldaten per Spracheingabe</h1>

  <textarea id="recognized" placeholder="Hier erscheint der erkannte Text (bearbeitbar)"></textarea>
  <br>
  <button id="record">Aufnahme starten</button>
  <button id="stop">Aufnahme stoppen</button>
  <button id="save">Speichern</button>

  <div id="timeFilters">
    <button onclick="setRange('1w')">1W</button>
    <button onclick="setRange('1m')">1M</button>
    <button onclick="setRange('3m')">3M</button>
    <button onclick="setRange('ytd')">YTD</button>
    <button onclick="setRange('max')">Max</button>
  </div>

  <div id="chartBox">
    <canvas id="vitalChart"></canvas>
  </div>

  <div id="metricFilters">
    <button onclick="setMetric('weight')">Gewicht</button>
    <button onclick="setMetric('bp')">Blutdruck</button>
    <button onclick="setMetric('pulse')">Puls</button>
  </div>

  <h2>Gespeicherte EintrÃ¤ge</h2>
  <ul id="entries"></ul>
  <button onclick="downloadData()">ðŸ“¥ Daten herunterladen</button>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let recognition;
    let vitalData = JSON.parse(localStorage.getItem("vitalData")) || [];
    let chart, currentMetric = "weight", currentRange = "1w";

    function renderEntries() {
      const ul = document.getElementById("entries");
      ul.innerHTML = "";
      vitalData.forEach((d, i) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <strong>${new Date(d.date).toLocaleDateString()}</strong><br>
          Gewicht: ${d.weight ?? "-"} kg<br>
          Blutdruck: ${d.syst ?? "-"} / ${d.diast ?? "-"} mmHg<br>
          Puls: ${d.pulse ?? "-"} bpm
          <button class="delete-btn" onclick="deleteEntry(${i})">âœ•</button>
        `;
        ul.appendChild(li);
      });
    }

    function deleteEntry(i) {
      vitalData.splice(i, 1);
      localStorage.setItem("vitalData", JSON.stringify(vitalData));
      renderEntries();
      updateChart();
    }

    function parseInput(text) {
      const gewicht = text.match(/(\d{2,3}[,.]\d|\d{2,3})\s?(kg|Kilogramm)?/i);
      const blutdruck = text.match(/(\d{2,3})\s?(zu|\/|und)\s?(\d{2,3})/i);
      const puls = text.match(/Puls\s?(\d{2,3})/i);

      return {
        date: new Date(),
        weight: gewicht ? parseFloat(gewicht[1].replace(",", ".")) : null,
        syst: blutdruck ? parseInt(blutdruck[1]) : null,
        diast: blutdruck ? parseInt(blutdruck[3]) : null,
        pulse: puls ? parseInt(puls[1]) : null
      };
    }

    document.getElementById("record").onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Spracherkennung nicht verfÃ¼gbar.");
        return;
      }
      recognition = new webkitSpeechRecognition();
      recognition.lang = "de-DE";
      recognition.interimResults = false;
      recognition.onresult = e => {
        document.getElementById("recognized").value = e.results[0][0].transcript;
      };
      recognition.start();
    };

    document.getElementById("stop").onclick = () => { if (recognition) recognition.stop(); };

    document.getElementById("save").onclick = () => {
      const text = document.getElementById("recognized").value;
      const data = parseInput(text);
      if (data.weight || data.syst || data.pulse) {
        // Testdaten simulieren: zurÃ¼ckdatieren
        data.date = new Date(Date.now() - vitalData.length * 24*60*60*1000);
        vitalData.push(data);
        localStorage.setItem("vitalData", JSON.stringify(vitalData));
        renderEntries();
        updateChart();
      } else {
        alert("Keine Vitaldaten erkannt.");
      }
    };

    function setMetric(m) { currentMetric = m; updateChart(); }
    function setRange(r) { currentRange = r; updateChart(); }

    const ctx = document.getElementById("vitalChart").getContext("2d");
    chart = new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { autoSkip: true, maxTicksLimit: 7 } },
          y: {}
        }
      }
    });

    function updateChart() {
      let filtered = [...vitalData]; // Filter nach Zeit kÃ¶nnte hier ergÃ¤nzt werden
      chart.data.labels = filtered.map(d => new Date(d.date).toLocaleDateString());
      chart.data.datasets = [];

      if (currentMetric === "weight") {
        chart.data.datasets.push({
          label: "Gewicht",
          data: filtered.map(d => d.weight),
          borderColor: "#1565c0",
          tension: 0.3,
          pointRadius: 3
        });
        let last = filtered.length ? filtered[filtered.length-1].weight : 0;
        chart.options.scales.y.min = last - 2;
        chart.options.scales.y.max = last + 2;
        chart.options.scales.y.ticks = { stepSize: 1, callback: v => v + " kg" };
      }

      if (currentMetric === "bp") {
        chart.data.datasets.push({
          label: "Systolisch",
          data: filtered.map(d => d.syst),
          borderColor: "#e53935",
          tension: 0.3,
          pointRadius: 3
        });
        chart.data.datasets.push({
          label: "Diastolisch",
          data: filtered.map(d => d.diast),
          borderColor: "#43a047",
          tension: 0.3,
          pointRadius: 3
        });
        chart.options.scales.y.min = 50;
        chart.options.scales.y.max = 200;
        chart.options.scales.y.ticks = { stepSize: 25 };
      }

      if (currentMetric === "pulse") {
        chart.data.datasets.push({
          label: "Puls",
          data: filtered.map(d => d.pulse),
          borderColor: "#e67e22",
          tension: 0.3,
          pointRadius: 3
        });
        // âœ… feste Achse fÃ¼r Puls
        chart.options.scales.y.min = 55;
        chart.options.scales.y.max = 90;
        chart.options.scales.y.ticks = { stepSize: 5, callback: v => v + " bpm" };
      }

      chart.update();
    }

    function downloadData() {
      let csv = "Datum,Gewicht,Systolisch,Diastolisch,Puls\n";
      vitalData.forEach(d => {
        csv += `${new Date(d.date).toLocaleDateString()},${d.weight ?? ""},${d.syst ?? ""},${d.diast ?? ""},${d.pulse ?? ""}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "vitaldaten.csv";
      a.click();
    }

    renderEntries();
    updateChart();
  </script>
</body>
</html>
