<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VitalApp</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2e7d32">

  <!-- App Icons f√ºr iOS -->
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon-180.png">
  <link rel="apple-touch-icon" sizes="152x152" href="apple-touch-icon-152.png">
  <link rel="apple-touch-icon" sizes="167x167" href="apple-touch-icon-167.png">
  <link rel="apple-touch-icon" href="apple-touch-icon.png"> <!-- Fallback -->

  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Helvetica,Arial,sans-serif;margin:18px;background:#f7f7f7;color:#222}
    h1{font-size:1.4em}
    button{padding:10px;border-radius:8px;border:none;font-size:15px;margin:6px 4px;cursor:pointer}
    #start{background:#2e7d32;color:#fff} #stop{background:#b71c1c;color:#fff}
    #save{background:#1565c0;color:#fff} #clear{background:#6d4c41;color:#fff}
    #recognized{padding:10px;background:#eee;border-radius:8px;min-height:48px}
    textarea{width:100%;min-height:80px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:8px}
    ul{list-style:none;padding:0}
    li{background:#fff;padding:10px;border-radius:8px;margin:6px 0;display:flex;justify-content:space-between;align-items:center}
    .small{font-size:0.9em;color:#666}
    .delete-btn{background:#d32f2f;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer}
  </style>
</head>
<body>
  <h1>Vitaldaten (PWA)</h1>
  <div id="recognized" aria-live="polite">Noch nichts erkannt‚Ä¶</div>

  <div style="margin-top:8px">
    <button id="start">üé§ Aufnehmen</button>
    <button id="stop">‚èπÔ∏è Stoppen</button>
    <button id="save">üíæ Speichern</button>
    <button id="pasteToInput" title="In Eingabefeld √ºbernehmen">‚úèÔ∏è In Formular √ºbernehmen</button>
    <button id="clear">üßπ Clear</button>
  </div>

  <p class="small">Falls die Browser-Spracherkennung auf deinem iPhone nicht funktioniert: tippe in das Feld unten und nutze das <strong>iOS-Diktat</strong> (Mikrofon-Taste in der Tastatur).</p>

  <textarea id="manualInput" placeholder="Oder hier sprechen/diktieren (Diktier-Taste auf iOS-Tastatur)"></textarea>

  <h2>Gespeicherte Eintr√§ge</h2>
  <ul id="entries"></ul>

  <script>
    // --------- Speech recognition mit l√§ngerem Einsprechen ----------
    let recognition = null;
    let isRecording = false;
    let recognizedText = "";

    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognition = new SR();
      recognition.lang = "de-DE";
      recognition.continuous = true;      // dauerhaft zuh√∂ren
      recognition.interimResults = true;  // Zwischenergebnisse zeigen

      recognition.onresult = (event) => {
        let finalText = recognizedText; // bisher erkannter Text behalten
        let interim = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalText += " " + transcript;   // endg√ºltiges Ergebnis hinzuf√ºgen
          } else {
            interim += " " + transcript;     // Zwischenergebnis
          }
        }

        recognizedText = finalText.trim();
        document.getElementById("recognized").textContent =
          (finalText + " " + interim).trim();
      };

      recognition.onerror = (e) => {
        console.warn("Recognition error", e);
      };
    } else {
      console.info("Keine Web Speech API im Browser verf√ºgbar");
    }

    document.getElementById("start").onclick = () => {
      if (!recognition) { 
        alert("Spracherkennung nicht unterst√ºtzt. Nutze das iOS-Diktat im Eingabefeld."); 
        return; 
      }
      if (!isRecording) { 
        recognizedText = ""; // beim Start zur√ºcksetzen
        recognition.start(); 
        isRecording = true; 
      }
    };

    document.getElementById("stop").onclick = () => {
      if (recognition && isRecording) { 
        recognition.stop(); 
        isRecording = false; 
      }
    };

    // --------- Clear-Funktion ----------
    document.getElementById("clear").onclick = () => {
      recognizedText = "";
      document.getElementById("recognized").textContent = "Noch nichts erkannt‚Ä¶";
    };

    // --------- Fallback: √úbernehme erkannten Text ins Textfeld ----------
    document.getElementById("pasteToInput").onclick = () => {
      const txt = recognizedText || "";
      const ta = document.getElementById("manualInput");
      ta.value = (ta.value ? ta.value + "\n" : "") + txt;
    };

    // --------- Verbesserter Parser ----------
    function parseVitaldaten(text) {
      text = (text || "").toLowerCase();

      const g = text.match(/(\d{1,3}[.,]?\d?)\s*(kg|kilo)?/);
      const bp = text.match(/(\d{2,3})\s*(?:\/|zu|und| )\s*(\d{2,3})/);
      const p = text.match(/puls\s*(\d{2,3})/) ||
                text.match(/(\d{2,3})\s*bpm/) ||
                text.match(/puls\s*ist\s*(\d{2,3})/);

      if (!g || !bp || !p) return null;

      const gewicht = parseFloat(g[1].replace(",", "."));
      const syst = parseInt(bp[1]);
      const diast = parseInt(bp[2]);
      const puls = parseInt(p[1]);

      return {
        datum: new Date().toISOString(),
        gewicht,
        systolisch: syst,
        diastolisch: diast,
        puls
      };
    }

    // --------- Speichern / Rendern / L√∂schen ----------
    function renderEntries() {
      const entries = JSON.parse(localStorage.getItem("vitaldaten") || "[]");
      const ul = document.getElementById("entries");
      ul.innerHTML = "";
      entries.forEach((e, idx) => {
        const li = document.createElement("li");
        li.innerHTML = `<div>
            <strong>${new Date(e.datum).toLocaleString()}</strong><br>
            Gewicht: ${e.gewicht} kg ¬∑ Blutdruck: ${e.systolisch}/${e.diastolisch} mmHg ¬∑ Puls: ${e.puls} bpm
          </div>`;
        const delBtn = document.createElement("button");
        delBtn.textContent = "‚ùå";
        delBtn.className = "delete-btn";
        delBtn.onclick = () => {
          entries.splice(idx, 1);
          localStorage.setItem("vitaldaten", JSON.stringify(entries));
          renderEntries();
        };
        li.appendChild(delBtn);
        ul.appendChild(li);
      });
    }

    document.getElementById("save").onclick = () => {
      const manual = document.getElementById("manualInput").value.trim();
      const textToParse = manual || recognizedText;
      if (!textToParse) { alert("Kein Text zum Speichern."); return; }
      const parsed = parseVitaldaten(textToParse);
      if (!parsed) { alert("Keine Vitaldaten im Text erkannt. Beispiel: '72,5 kg, Blutdruck 120 zu 80, Puls 68'"); return; }
      const arr = JSON.parse(localStorage.getItem("vitaldaten") || "[]");
      arr.unshift(parsed);
      localStorage.setItem("vitaldaten", JSON.stringify(arr));
      document.getElementById("manualInput").value = "";
      renderEntries();
    };

    renderEntries();

    // --------- Service Worker registrieren (f√ºr Offline) ----------
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js').catch(e => console.warn("SW failed", e));
    }
  </script>
</body>
</html>
